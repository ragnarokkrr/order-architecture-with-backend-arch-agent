# ADR-0001: Use SAGA Choreography for Distributed Transactions

## Status
Accepted

## Context
The order processing system spans three microservices (Order, Payment, Inventory), each with its own database. Traditional two-phase commit (2PC) is unsuitable for microservices due to:
- Tight coupling and reduced availability
- Performance bottlenecks (blocking)
- Complex failure scenarios in distributed systems

We need a distributed transaction pattern that maintains eventual consistency while allowing independent service scaling and deployment.

## Decision
Implement SAGA pattern using **choreography** (event-driven coordination) rather than orchestration:

- **Order Service** acts as SAGA initiator and state tracker
- Each service (Payment, Inventory) listens to relevant events and publishes outcome events
- **Compensating transactions** handle failures (e.g., refund payment, release inventory)
- **Outbox pattern** ensures exactly-once event publishing alongside DB transactions

**SAGA Flow**:
1. Order Service creates order (PENDING), publishes OrderCreated event
2. Payment Service processes payment, publishes PaymentProcessed or PaymentFailed
3. Inventory Service reserves stock, publishes InventoryReserved or InventoryFailed
4. Order Service listens to outcome events, updates order status (COMPLETED or FAILED)
5. If any step fails, OrderFailed event triggers compensating transactions

## Consequences

**Positive**:
- Services remain loosely coupled; no central orchestrator dependency
- High availability; failures in one service don't block others
- Horizontal scalability; each service scales independently
- Clear audit trail via event log

**Negative**:
- Increased complexity in tracing distributed workflows (mitigated with correlation IDs, distributed tracing)
- Eventual consistency; order status may lag behind actual state
- Compensating transaction logic required in each service
- Testing requires end-to-end SAGA scenario coverage

**Risks**:
- Event ordering issues if Kafka partitions not properly configured
- Compensation failures leave system in inconsistent state (requires manual intervention tooling)

**Follow-ups**:
- Implement correlation IDs for all events
- Add distributed tracing (Jaeger) to visualize SAGA flows
- Build SAGA state dashboard for operations team
- Create runbook for manual compensation failures
