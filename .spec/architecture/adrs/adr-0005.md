# ADR-0005: Outbox Pattern for Event Publishing

## Status
Accepted

## Context
Order Service must publish events (OrderCreated, OrderCompleted, OrderFailed) reliably as part of database transactions. Naive approach (publish event after DB commit) risks:
- **Dual Write Problem**: DB commit succeeds but Kafka publish fails → data inconsistency
- **Lost Events**: Application crashes after DB commit, before Kafka publish
- **Duplicate Events**: Kafka publish succeeds but DB commit fails → retry causes duplicates

We need **exactly-once** event publishing semantics without distributed transactions (2PC).

## Decision
Implement **Outbox Pattern** for event publishing:

1. **Outbox Table**: Add `outbox` table to Order Service PostgreSQL database
   - Schema: `id`, `event_id`, `event_type`, `payload (jsonb)`, `created_at`, `published (boolean)`
2. **Transactional Write**: Insert order + outbox event in **same database transaction**
3. **Event Publisher**: Separate process (poller or CDC) reads unpublished events from outbox, publishes to Kafka, marks as published

**Implementation Options** (MVP1 vs MVP2):
- **MVP1**: Scheduled poller (Spring @Scheduled task, every 1s) queries unpublished events
- **MVP2**: Change Data Capture (Debezium) streams outbox changes to Kafka in near-real-time

**Idempotency**: Kafka consumers deduplicate events using `event_id` (store processed IDs in DB, TTL 7 days)

## Consequences

**Positive**:
- **Reliability**: Events always published if DB transaction commits (no lost events)
- **Consistency**: Order creation and event publishing are atomic (same transaction)
- **Exactly-Once**: Outbox ensures no duplicate publishes; consumers handle idempotency
- **Auditability**: Outbox table serves as event log for debugging

**Negative**:
- **Latency**: Polling introduces delay (up to 1s in MVP1); CDC reduces to <100ms but adds complexity
- **Storage Overhead**: Outbox table grows (requires cleanup job for old published events)
- **Operational Complexity**: CDC (MVP2) requires Debezium setup, PostgreSQL WAL configuration

**Risks**:
- Outbox poller crashes → events delayed until restart (mitigated by health checks, Kubernetes restarts)
- Outbox table grows unbounded → performance degradation (mitigated by cleanup job, partitioning)

**Follow-ups**:
- Implement outbox cleanup job (delete events older than 7 days)
- Monitor outbox table size and polling lag
- Plan CDC migration (Debezium) for MVP2
- Add alerting for unpublished events older than 5 seconds
